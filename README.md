# <span style="color:red">Актуальная версия сервера лежит на ветке [**stable**](https://github.com/nj-vs-vh/tunka-telemetry-server/tree/stable). Здесь хранятся наработки для развития **pyindigo**!</span>

# Телеметрия в эксперименте Тунка

## Установка

1. Склонировать этот репозиторий

```bash
git clone https://github.com/nj-vs-vh/tunka-telemetry-server.git camera-server
```

2. Установить фреймворк INDIGO в субдиректорию, скомпилировать исполняемиые файлы и библиотеки

```bash
cd camera-server
git clone https://github.com/indigo-astronomy/indigo.git
cd indigo
make all
```

3. Скомпилировать кастомный CCD-клиент и модуль-расширение Python. На этом шаге `make` автоматически создаст виртуальное окружения с нужной версией Python и всеми зависимостями; скомпилирует Indigo-клиент; скомпилирует и построит расширение Python с интерфейсом для Indigo.

```bash
cd ../pyindigo
make install
```

4. Важно! Для работы с динамическими библиотеками INDIGO необходимо добавить в переменную окружения `LD_LIBRARY_PATH` папку indigo/build/lib/. Для этого проще всего добавить в activate-скрипт виртуального окружения соответствующую команду: ```nano indgenv/bin/activate```, вставить в конец `export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:"/home/njvh/Documents/Science/sphere/camera-server/indigo/build/lib"`, сохранить, запустить файл ещё раз.

## Камера

Модель камеры: ZWO ASI120MC-S

Режим работы: подобрать на месте, рабочий вариант (Москва, температура 29 градусов), сумма 10 кадров по 10 секунд, усиление 3-4 (код INDI, максимум — 100). Варианты режимов: стриминг, эмуляция стриминга на уровне клиента, просто длинная экспозиция. Потребуются дарки в начале и в конце ночи (кадры при закрытой крышке). Нужен режим набора библиотеки дарков (в плохую ночь).

Хранение данных: накопление в течение определённого времени (напр. 5 минут), сохранение сумма/среднего за это время. При этом анализировать можно каждый кадр и сохранять данные анализа чаще (каждые 10 секунд). С точки зрения веб-интерфейса можно сохранять JPEG-превью.

### Получение данных с камеры

Используется фреймворк [INDIGO](https://github.com/indigo-astronomy/indigo), для камеры есть готовый [INDIGO-драйвер](https://github.com/indigo-astronomy/indigo/tree/master/indigo_drivers/ccd_asi), со стороны нашего приложения используется кастомный сервер на основе [примера](https://github.com/indigo-astronomy/indigo/blob/master/indigo_examples/dynamic_driver_client.c), снабжённый интерфейсом для вызова из Python в виде объекта-адаптера.

Использование из кода: TODO

### Обработка данных с камеры

1. Угловые харакетристики камеры (tx, ty для каждого пикселя) — измерить в лаборатории.

2. Привязка поля зрения камеры к небесной сфере по известным ярким звёздам.

3. Оверлей с положениями звёзд, созвездий, координатной сеткой.

4. Выделение облаков — разбираемся на месте, сложно предсказать заранее.

## Прочая телеметрия

TODO

## Веб-интерфейс

TODO
